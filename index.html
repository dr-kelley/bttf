<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Back to the Future: Kinematics Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }
        
        .subtitle {
            margin: 5px 0;
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .problem-statement {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }
        
        .control-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .control-section h3 {
            margin-top: 0;
            color: #667eea;
            font-size: 1.1em;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #764ba2;
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .preset-btn {
            background: #28a745;
        }
        
        .preset-btn:hover {
            background: #218838;
        }
        
        .danger-btn {
            background: #dc3545;
        }
        
        .danger-btn:hover {
            background: #c82333;
        }
        
        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 80px;
            margin: 0 5px;
        }
        
        label {
            font-weight: 500;
            margin-right: 5px;
        }
        
        .graphs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .graphs-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .graph-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .result-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        
        .result-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .result-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        
        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .point-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .point-item {
            padding: 5px;
            margin: 3px 0;
            background: #f8f9fa;
            border-radius: 3px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .delete-point {
            background: #dc3545;
            padding: 2px 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Back to the Future: Kinematics Simulator</h1>
        <div class="subtitle">Explore how different velocity assumptions lead to different conclusions</div>
        <div class="subtitle"><em>"Roads? Where we're going, we don't need roads... but we do need physics!"</em></div>
    </div>

    <div class="problem-statement">
        <h2>The Problem</h2>
        <p><strong>In the penultimate scene in Back to the Future,</strong> Marty McFly must accelerate Prof. Brown's Time Machine, a DeLorean DMC-12, to 88 mph and pass under an electrical wire at the moment lightning strikes the clock tower, powering the flux capacitor and sending him back to the future!</p>
        <p><strong>Known information:</strong></p>
        <ul>
            <li>Marty and the DeLorean start to accelerate at some unknown distance from the clock tower</li>
            <li>Total travel time: <strong>1 minute 44 seconds</strong> (104 seconds)</li>
            <li>Target velocity: <strong>88 mph</strong> (39.3 m/s or 129 ft/s)</li>
            <li>According to Road and Truck (1983): DeLorean can accelerate 0→60 mph in 10.5 seconds</li>
        </ul>
        <p><strong>Questions:</strong> Draw all relevant time graphs. How far did Marty travel? What assumptions do you make?</p>
    </div>

    <div class="main-container">
        <div class="graphs-column">
            <div class="graph-container">
                <div id="velocityGraph"></div>
            </div>
            <div class="graph-container">
                <div id="positionGraph"></div>
            </div>
            <div class="graph-container">
                <div id="accelerationGraph"></div>
            </div>
        </div>

        <div class="controls">
            <div class="instructions">
                <strong>Instructions:</strong> Use the controls below to build your velocity profile. 
                The simulation will automatically calculate and display the corresponding position and acceleration graphs.
                Try different assumptions and see how they affect the distance traveled!
            </div>

            <div class="control-section">
                <h3>Add Points</h3>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Time (s):</label>
                    <input type="number" id="manualTime" min="0" max="104" step="0.1" value="0" style="width: 100%; box-sizing: border-box;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Velocity (mph):</label>
                    <input type="number" id="manualVelocity" min="0" max="120" step="0.5" value="0" style="width: 100%; box-sizing: border-box;">
                </div>
                <button onclick="addManualPoint()" style="width: 100%;">Add Point</button>
            </div>

            <div class="control-section">
                <h3>Current Points</h3>
                <div id="pointList" class="point-list"></div>
            </div>

            <div class="control-section">
                <h3>Preset Scenarios</h3>
                <button class="preset-btn" onclick="loadConstantAcceleration()">Constant Acceleration</button>
                <button class="preset-btn" onclick="loadNaiveConstant()">Naive Constant</button>
                <button class="preset-btn" onclick="loadRoadTrackStats()">Road & Track Stats</button>
                <button class="preset-btn" onclick="loadHybridModel()">Hybrid Model</button>
                <button class="preset-btn" onclick="loadRealisticProfile()">Realistic Profile</button>
            </div>

            <div class="control-section">
                <h3>Graph Controls</h3>
                <button onclick="clearPoints()" class="danger-btn">Clear All Points</button>
                <button onclick="undoLastPoint()">Undo Last Point</button>
                <button onclick="sortPoints()">Sort Points by Time</button>
            </div>
        </div>
    </div>

    <div class="results">
        <h2>Calculated Results</h2>
        <div class="result-grid">
            <div class="result-item">
                <div class="result-label">Total Distance Traveled</div>
                <div class="result-value" id="totalDistance">-- miles</div>
            </div>
            <div class="result-item">
                <div class="result-label">Total Distance (metric)</div>
                <div class="result-value" id="totalDistanceMetric">-- km</div>
            </div>
            <div class="result-item">
                <div class="result-label">Final Velocity</div>
                <div class="result-value" id="finalVelocity">-- mph</div>
            </div>
            <div class="result-item">
                <div class="result-label">Average Velocity</div>
                <div class="result-value" id="avgVelocity">-- mph</div>
            </div>
            <div class="result-item">
                <div class="result-label">Max Acceleration</div>
                <div class="result-value" id="maxAccel">-- mph/s</div>
            </div>
            <div class="result-item">
                <div class="result-label">Hits Target Speed?</div>
                <div class="result-value" id="targetHit">--</div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let points = [];
        const TARGET_SPEED = 88; // mph
        const TOTAL_TIME = 104; // seconds

        // Conversion factors
        const MPH_TO_MS = 0.44704;
        const MPH_TO_FTS = 1.467;
        const MILES_TO_KM = 1.60934;
        const MILES_TO_FEET = 5280;

        // Initialize with starting point
        function initialize() {
            points = [{t: 0, v: 0}, {t: TOTAL_TIME, v: 0}];
            updateAll();
        }

        // Add point manually
        function addManualPoint() {
            const t = parseFloat(document.getElementById('manualTime').value);
            const v = parseFloat(document.getElementById('manualVelocity').value);
            
            if (isNaN(t) || isNaN(v)) {
                alert('Please enter valid numbers');
                return;
            }
            
            if (t < 0 || t > TOTAL_TIME) {
                alert(`Time must be between 0 and ${TOTAL_TIME} seconds`);
                return;
            }
            
            points.push({t: t, v: v});
            sortPoints();
            updateAll();
        }

        // Sort points by time
        function sortPoints() {
            points.sort((a, b) => a.t - b.t);
        }

        // Clear all points
        function clearPoints() {
            points = [{t: 0, v: 0}, {t: TOTAL_TIME, v: 0}];
            updateAll();
        }

        // Undo last point
        function undoLastPoint() {
            if (points.length > 2) {
                points.pop();
                updateAll();
            }
        }

        // Delete specific point
        function deletePoint(index) {
            if (points.length > 2) {
                points.splice(index, 1);
                updateAll();
            }
        }

        // Preset scenarios
        function loadConstantAcceleration() {
            // Simple constant acceleration to 88 mph
            points = [
                {t: 0, v: 0},
                {t: TOTAL_TIME, v: TARGET_SPEED}
            ];
            updateAll();
        }

        function loadNaiveConstant() {
            // Use Road & Track acceleration rate for entire duration
            // This is the "assumptions gone wrong" case
            // 0-60 in 10.5s means acceleration = 60/10.5 = 5.71 mph/s
            const accel = 60 / 10.5; // mph/s
            const finalVelocity = accel * TOTAL_TIME; // Will be ~594 mph!
            
            points = [
                {t: 0, v: 0},
                {t: TOTAL_TIME, v: finalVelocity}
            ];
            updateAll();
        }

        function loadRoadTrackStats() {
            // Use Road & Track acceleration: 0-60 in 10.5s
            // Extrapolate to 88 mph
            const accel = 60 / 10.5; // mph/s
            const timeToTarget = TARGET_SPEED / accel; // ~15.4s
            
            points = [
                {t: 0, v: 0},
                {t: timeToTarget, v: TARGET_SPEED},
                {t: TOTAL_TIME, v: TARGET_SPEED}
            ];
            updateAll();
        }

        function loadHybridModel() {
            // Accelerate at Road & Track rate, then coast, then accelerate again
            points = [
                {t: 0, v: 0},
                {t: 10.5, v: 60},
                {t: 50, v: 60},
                {t: 65, v: TARGET_SPEED},
                {t: TOTAL_TIME, v: TARGET_SPEED}
            ];
            updateAll();
        }

        function loadRealisticProfile() {
            // More realistic: acceleration decreases as speed increases
            // Real cars have decreasing acceleration at higher speeds due to drag
            // and power delivery characteristics
            points = [
                {t: 0, v: 0},
                {t: 5, v: 22},      // Fast acceleration from standstill
                {t: 10.5, v: 40},   // Slower than R&T stats initially
                {t: 20, v: 55},     // Continuing to accelerate
                {t: 35, v: 68},     // Rate slowing down
                {t: 55, v: 78},     // Getting harder to accelerate
                {t: 80, v: 85},     // Nearly at target
                {t: 100, v: 87.5},  // Almost there
                {t: TOTAL_TIME, v: TARGET_SPEED}  // Just hits 88 at the end
            ];
            updateAll();
        }

        // Calculate position by integrating velocity
        // Generate dense points for smooth curves
        function calculatePosition() {
            if (points.length < 2) return [];
            
            let positionPoints = [];
            let totalDistance = 0;
            
            // For each segment between velocity points
            for (let i = 1; i < points.length; i++) {
                const t1 = points[i-1].t;
                const t2 = points[i].t;
                const v1 = points[i-1].v * MPH_TO_MS; // Convert to m/s
                const v2 = points[i].v * MPH_TO_MS;
                
                // Generate many intermediate points for smooth curve
                const numSteps = Math.max(20, Math.ceil((t2 - t1) * 2)); // At least 20 points per segment
                
                for (let step = 0; step <= numSteps; step++) {
                    const fraction = step / numSteps;
                    const t = t1 + fraction * (t2 - t1);
                    
                    // Linear interpolation of velocity
                    const v = v1 + fraction * (v2 - v1);
                    
                    // If this is not the first point in the segment, integrate
                    if (step > 0) {
                        const dt = t - positionPoints[positionPoints.length - 1].t;
                        const vPrev = (positionPoints.length > 0) ? 
                            (v1 + (step - 1) / numSteps * (v2 - v1)) : v1;
                        
                        // Trapezoidal integration
                        const distance = (vPrev + v) * dt / 2;
                        totalDistance += distance;
                    }
                    
                    positionPoints.push({
                        t: t,
                        x: totalDistance
                    });
                }
            }
            
            return positionPoints;
        }

        // Calculate acceleration (derivative of velocity)
        function calculateAcceleration() {
            if (points.length < 2) return [];
            
            let accelPoints = [];
            
            for (let i = 1; i < points.length; i++) {
                const dt = points[i].t - points[i-1].t;
                const dv = points[i].v - points[i-1].v;
                
                if (dt > 0) {
                    const accel = dv / dt; // mph/s
                    accelPoints.push({
                        t: points[i-1].t,
                        a: accel
                    });
                    accelPoints.push({
                        t: points[i].t,
                        a: accel
                    });
                }
            }
            
            return accelPoints;
        }

        // Update all graphs and results
        function updateAll() {
            updatePointList();
            plotVelocity();
            plotPosition();
            plotAcceleration();
            updateResults();
        }

        // Update point list display
        function updatePointList() {
            const listDiv = document.getElementById('pointList');
            if (points.length === 0) {
                listDiv.innerHTML = '<em>No points added yet</em>';
                return;
            }
            
            let html = '';
            points.forEach((point, index) => {
                html += `
                    <div class="point-item">
                        <span>t = ${point.t.toFixed(1)}s, v = ${point.v.toFixed(1)} mph</span>
                        <button class="delete-point" onclick="deletePoint(${index})">Delete</button>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        // Plot velocity graph
        function plotVelocity() {
            const trace = {
                x: points.map(p => p.t),
                y: points.map(p => p.v),
                mode: 'lines+markers',
                name: 'Velocity',
                line: {color: '#667eea', width: 3},
                marker: {size: 8, color: '#764ba2'}
            };

            const targetLine = {
                x: [0, TOTAL_TIME],
                y: [TARGET_SPEED, TARGET_SPEED],
                mode: 'lines',
                name: 'Target: 88 mph',
                line: {color: 'red', width: 2, dash: 'dash'}
            };

            const layout = {
                title: 'Velocity vs. Time',
                xaxis: {title: 'Time (s)', range: [-2, TOTAL_TIME + 2]},
                yaxis: {title: 'Velocity (mph)', range: [-5, Math.max(100, ...points.map(p => p.v)) + 10]},
                hovermode: 'closest',
                showlegend: true
            };

            const config = {
                responsive: true,
                displayModeBar: true
            };

            Plotly.newPlot('velocityGraph', [trace, targetLine], layout, config);
            
            // Try multiple event handlers
            const velocityDiv = document.getElementById('velocityGraph');
            
            // Method 1: plotly_click
            velocityDiv.on('plotly_click', function(data) {
                console.log('Click detected:', data);
                if (data.points && data.points.length > 0) {
                    const t = data.points[0].x;
                    const v = data.points[0].y;
                    
                    const constrainedT = Math.max(0, Math.min(TOTAL_TIME, t));
                    const constrainedV = Math.max(0, v);
                    
                    points.push({t: constrainedT, v: constrainedV});
                    sortPoints();
                    updateAll();
                }
            });
            
            // Method 2: Try standard click event on the plot area
            velocityDiv.addEventListener('click', function(event) {
                // Get the plot's bounding box
                const plotDiv = event.currentTarget;
                const plotArea = plotDiv.querySelector('.nsewdrag');
                
                if (plotArea && plotArea.contains(event.target)) {
                    console.log('Direct click on plot area');
                    // This is a click on the actual plot area
                    // Try to convert pixel coordinates to data coordinates
                    const bb = plotArea.getBoundingClientRect();
                    const x = event.clientX - bb.left;
                    const y = event.clientY - bb.top;
                    
                    // Get the current axis ranges
                    const layout = velocityDiv.layout;
                    const xaxis = layout.xaxis;
                    const yaxis = layout.yaxis;
                    
                    // Convert pixel to data coordinates (approximate)
                    const t = xaxis.range[0] + (x / bb.width) * (xaxis.range[1] - xaxis.range[0]);
                    const v = yaxis.range[1] - (y / bb.height) * (yaxis.range[1] - yaxis.range[0]);
                    
                    console.log('Calculated coordinates:', t, v);
                    
                    if (t >= 0 && t <= TOTAL_TIME && v >= 0) {
                        points.push({t: t, v: v});
                        sortPoints();
                        updateAll();
                    }
                }
            });
        }

        // Plot position graph
        function plotPosition() {
            const positionPoints = calculatePosition();
            
            const trace = {
                x: positionPoints.map(p => p.t),
                y: positionPoints.map(p => p.x / 1609.34), // Convert m to miles
                mode: 'lines',
                name: 'Position',
                line: {color: '#28a745', width: 3},
                fill: 'tozeroy',
                fillcolor: 'rgba(40, 167, 69, 0.2)'
            };

            const layout = {
                title: 'Position vs. Time',
                xaxis: {title: 'Time (s)', range: [-2, TOTAL_TIME + 2]},
                yaxis: {title: 'Position (miles)'},
                hovermode: 'closest'
            };

            const config = {responsive: true};

            Plotly.newPlot('positionGraph', [trace], layout, config);
        }

        // Plot acceleration graph
        function plotAcceleration() {
            const accelPoints = calculateAcceleration();
            
            if (accelPoints.length === 0) {
                Plotly.newPlot('accelerationGraph', [], {
                    title: 'Acceleration vs. Time',
                    xaxis: {title: 'Time (s)'},
                    yaxis: {title: 'Acceleration (mph/s)'}
                });
                return;
            }

            const trace = {
                x: accelPoints.map(p => p.t),
                y: accelPoints.map(p => p.a),
                mode: 'lines',
                name: 'Acceleration',
                line: {color: '#dc3545', width: 3},
                fill: 'tozeroy',
                fillcolor: 'rgba(220, 53, 69, 0.2)'
            };

            const layout = {
                title: 'Acceleration vs. Time',
                xaxis: {title: 'Time (s)', range: [-2, TOTAL_TIME + 2]},
                yaxis: {title: 'Acceleration (mph/s)'},
                hovermode: 'closest'
            };

            const config = {responsive: true};

            Plotly.newPlot('accelerationGraph', [trace], layout, config);
        }

        // Update results display
        function updateResults() {
            const positionPoints = calculatePosition();
            const accelPoints = calculateAcceleration();
            
            if (positionPoints.length === 0) return;
            
            const totalDistanceM = positionPoints[positionPoints.length - 1].x;
            const totalDistanceMiles = totalDistanceM / 1609.34;
            const totalDistanceKm = totalDistanceM / 1000;
            
            const finalVelocity = points[points.length - 1].v;
            
            // Calculate average velocity
            const avgVelocity = totalDistanceMiles / (TOTAL_TIME / 3600); // mph
            
            // Find max acceleration
            let maxAccel = 0;
            if (accelPoints.length > 0) {
                maxAccel = Math.max(...accelPoints.map(p => Math.abs(p.a)));
            }
            
            // Check if target speed was hit
            const hitTarget = points.some(p => p.v >= TARGET_SPEED - 0.5);
            
            document.getElementById('totalDistance').textContent = totalDistanceMiles.toFixed(2) + ' miles';
            document.getElementById('totalDistanceMetric').textContent = totalDistanceKm.toFixed(2) + ' km';
            document.getElementById('finalVelocity').textContent = finalVelocity.toFixed(1) + ' mph';
            document.getElementById('avgVelocity').textContent = avgVelocity.toFixed(1) + ' mph';
            document.getElementById('maxAccel').textContent = maxAccel.toFixed(2) + ' mph/s';
            document.getElementById('targetHit').textContent = hitTarget ? '✅ Yes' : '❌ No';
            document.getElementById('targetHit').style.color = hitTarget ? '#28a745' : '#dc3545';
        }

        // Initialize on load
        window.onload = function() {
            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error('Plotly failed to load. Retrying...');
                // Try to reload Plotly
                const script = document.createElement('script');
                script.src = 'https://cdn.plot.ly/plotly-2.27.0.min.js';
                script.onload = function() {
                    console.log('Plotly loaded successfully');
                    initialize();
                };
                script.onerror = function() {
                    alert('Failed to load Plotly library. Please check your internet connection and refresh the page.');
                };
                document.head.appendChild(script);
            } else {
                initialize();
            }
        };
    </script>
</body>
</html>
